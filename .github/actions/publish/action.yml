---
name: Download balenaOS and upload as a release asset
description: Example of how to use upload-balena-release-asset action

inputs:
  json:
    description: 'JSON stringified object containing all the inputs from the calling workflow'
    required: true
  secrets:
    description: 'JSON stringified object containing all the secrets from the calling workflow'
    required: true
  variables:
    description: 'JSON stringified object containing all the variables from the calling workflow'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Download balenaCLI
      uses: balena-io-examples/setup-balena-action@main
      with:
        balena-token: ${{ fromJSON(inputs.secrets).BALENA_API_KEY }}

    - name: Download balenaOS image
      shell: bash
      run: |
        balena -v
        balena whoami
        balena os download generic-amd64 -o image.img
        mkdir test
        echo "file" > test/file.txt
        echo "toexclude" > test/exclude.txt
        mkdir test/subdir
        echo "subdirfile" > test/subdir/subdirfile.txt

    - name: Upload release asset
      uses: balena-io/upload-balena-release-asset@88be4cb07938208f6b171428b0a2aac6aa12c9bf
      id: upload
      with:
        balena-token: ${{ fromJSON(inputs.secrets).STAGING_API_KEY }}
        release-id: 171635
        path: |
          ./
          !test/exclude.txt
        overwrite: true
        balena-host: 'balena-staging.com'
        if-file-path-not-found: 'error'

    - name: assert upload
      shell: bash
      run: |
        echo "Upload result: ${{ steps.upload.outputs.release-assets }}"
